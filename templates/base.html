<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="STEM Academic Resources Platform - Access quality educational materials for IGCSE, A-Level, and university preparation">
    <meta name="keywords" content="STEM, academic resources, education, IGCSE, A-Level, physics, mathematics, chemistry, biology">
    <meta name="author" content="STEM Academic Resources Platform">
    
    <title>{% block title %}STEM Academic Resources Platform{% endblock %}</title>
    
    
    <!-- Bootstrap CSS - Local -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <!-- Font Awesome - Local -->
    <link href="{{ url_for('static', filename='css/font-awesome.min.css') }}" rel="stylesheet">
    
    <style>
        :root {
            /* STEM Academic Platform - Professional blue theme */
            --color-primary: #3b82f6; /* Professional blue for academic feel */
            --color-primary-light: #60a5fa;
            --color-primary-dark: #1e3a8a;
            --color-secondary: #0d9488;
            --color-neutral-light: #f8fafc;
            --color-neutral: #64748b;
            --color-neutral-dark: #1e293b;
            
            /* Menu specific variables */
            --menu-bg: linear-gradient(135deg, #ffffff 0%, #fdfdfd 100%);
            --menu-border: rgba(226, 232, 240, 0.8);
            --menu-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 8px 25px rgba(0, 0, 0, 0.04);
            --menu-item-hover: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(99, 102, 241, 0.05) 100%);
            --menu-text: #1e293b;
            --menu-text-secondary: #64748b;
            --menu-animation: cubic-bezier(0.34, 1.56, 0.64, 1);
            
            /* Academic color palette */
            --warm-primary: #3b82f6;
            --warm-primary-dark: #1e3a8a;
            --warm-primary-light: #60a5fa;
            --warm-secondary: #0d9488;
            --warm-neutral: #f8fafc;
            --warm-background: #ffffff;
            --warm-success: #059669;
            --warm-info: #0ea5e9;
            --warm-warning: #d97706;
            --warm-white: #FFFFFF;
            
            /* Typography System */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            --font-serif: Georgia, Cambria, "Times New Roman", Times, serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--warm-background) 0%, #f8fafc 100%);
            min-height: 100vh;
            font-family: var(--font-sans);
            color: var(--color-neutral-dark);
            line-height: 1.6;
            padding-top: 80px; /* Add padding to prevent navbar overlap */
        }
        
        /* Professional navigation bar */
        .navbar {
            background: rgba(248, 250, 252, 0.95) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(59, 130, 246, 0.1);
            border-bottom: 1px solid rgba(59, 130, 246, 0.1);
            transition: all 0.3s ease;
        }
        
        /* Dropdown menu styles */
        .dropdown-menu {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.15);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.15);
            padding: 0.75rem 0;
            min-width: 220px;
        }
        
        .dropdown-item {
            padding: 0.75rem 1.25rem;
            color: var(--color-neutral-dark);
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 0 0.5rem;
        }
        
        .dropdown-item:hover {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
            color: white;
            transform: translateX(2px);
        }
        
        .dropdown-divider {
            border-top: 1px solid rgba(59, 130, 246, 0.1);
            margin: 0.5rem 0;
        }
        
        /* Multi-level dropdown */
        .dropdown-submenu {
            position: relative;
        }
        
        .dropdown-submenu .dropdown-menu {
            top: 0;
            left: 100%;
            margin-top: -6px;
            margin-left: -1px;
        }
        
        .dropdown-submenu:hover > .dropdown-menu {
            display: block;
        }
        
        @media (max-width: 767.98px) {
            .dropdown-submenu .dropdown-menu {
                position: static;
                float: none;
                width: auto;
                margin-top: 0;
                background: rgba(248, 250, 252, 0.5);
                border: none;
                box-shadow: inset 0 2px 4px rgba(59, 130, 246, 0.1);
            }
        }
        
        .navbar-brand {
            color: #92400e !important;
            font-family: Georgia, Cambria, "Times New Roman", Times, serif;
            font-size: 1.4rem;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        
        .navbar-brand:hover {
            color: #d97706 !important;
        }
        
        /* 现代化卡片设计 */
        .card {
            background: var(--warm-white);
            border: 1px solid var(--warm-primary-light);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(141, 110, 99, 0.12);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .card:hover {
            box-shadow: 0 15px 50px rgba(141, 110, 99, 0.18);
            transform: translateY(-3px);
        }
        
        /* 现代化按钮设计 */
        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            border: none;
            color: #fff;
            font-weight: 500;
            border-radius: 50px;
            padding: 12px 24px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.2);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--color-primary-dark) 0%, #7c2d12 100%);
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(217, 119, 6, 0.3);
        }
        
        .btn-outline-primary {
            background-color: transparent;
            border: 2px solid var(--color-primary);
            color: var(--color-primary);
            font-weight: 500;
            border-radius: 50px;
            padding: 10px 24px;
            transition: all 0.3s ease;
        }
        
        .btn-outline-primary:hover {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            border-color: var(--color-primary);
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(217, 119, 6, 0.3);
        }
        
        /* 现代化表单控件 */
        .form-control {
            border-radius: 15px;
            border: 2px solid #fde68a;
            padding: 14px 18px;
            transition: all 0.3s ease;
            font-family: 'Segoe UI', sans-serif;
            background: rgba(255, 255, 255, 0.8);
        }
        
        .form-control:focus {
            border-color: var(--warm-primary);
            box-shadow: 0 0 0 0.2rem rgba(217, 119, 6, 0.25);
            background: #fff;
        }
        
        /* 现代化警告框 */
        .alert {
            border-radius: 15px;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .alert-success {
            background: linear-gradient(135deg, var(--warm-success) 0%, #15803d 100%);
            color: white;
        }
        
        .alert-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }
        
        .alert-info {
            background: linear-gradient(135deg, var(--warm-info) 0%, #0284c7 100%);
            color: white;
        }
        
        /* Page Headers - White and Bold */
        h1.h2 {
            color: white !important;
            font-weight: 700 !important;
        }
        
        /* Modern navigation links */
        .nav-link {
            color: var(--color-neutral) !important;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
            padding: 0.75rem 1rem !important;
            border-radius: 8px;
            margin: 0 4px;
        }
        
        .nav-link:hover {
            color: var(--color-primary) !important;
            background: rgba(59, 130, 246, 0.08);
            border-bottom-color: var(--color-primary-light);
        }
        
        .nav-link.active {
            color: var(--color-primary-dark) !important;
            background: rgba(59, 130, 246, 0.12);
            border-bottom-color: var(--color-primary);
        }
        
        .dropdown-toggle::after {
            margin-left: 0.5em;
            vertical-align: 0.125em;
            color: var(--color-primary);
        }
        
        /* 标题样式 */
        h1, h2, h3, h4, h5, h6 {
            color: var(--warm-primary-dark);
            font-family: 'Georgia', serif;
        }
        
        /* 特定的h1.h2标题样式 - 白色加粗 */
        h1.h2 {
            color: white !important;
            font-weight: bold !important;
            font-family: 'Georgia', serif;
        }
        
        /* 工具类 */
        .text-primary {
            color: var(--warm-primary) !important;
        }
        
        .bg-primary {
            background: linear-gradient(135deg, var(--warm-primary) 0%, var(--warm-primary-dark) 100%) !important;
        }
        
        .border-primary {
            border-color: var(--warm-primary) !important;
        }
        
        /* 现代化动画 */
        @keyframes blob {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }

        .animate-blob {
            animation: blob 7s infinite;
        }

        .animation-delay-2000 {
            animation-delay: 2s;
        }

        .animation-delay-4000 {
            animation-delay: 4s;
        }
        
        /* 全局增强样式 */
        .img-fluid {
            transition: transform 0.3s ease;
        }
        
        .img-fluid:hover {
            transform: scale(1.02);
        }
        
        /* 文本截断工具类 */
        .text-truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .text-truncate-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* 阴影工具类 */
        .shadow-warm {
            box-shadow: 0 10px 40px rgba(141, 110, 99, 0.12) !important;
        }
        
        .shadow-warm-lg {
            box-shadow: 0 15px 50px rgba(141, 110, 99, 0.18) !important;
        }
        
        /* 渐变背景工具类 */
        .bg-gradient-warm {
            background: linear-gradient(135deg, var(--warm-background) 0%, #FFF3E0 100%) !important;
        }
        
        .bg-gradient-primary {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%) !important;
        }

        /* Three-Tier Mega Dropdown Styles */
        .mega-dropdown {
            position: relative;
        }
        
        .mega-dropdown-menu,
        .level-dropdown-menu,
        .category-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: linear-gradient(135deg, #ffffff 0%, #fdfdfd 100%);
            border-radius: 16px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.08),
                0 8px 25px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            opacity: 0;
            visibility: hidden;
            transform: translateY(15px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1000;
            backdrop-filter: blur(20px);
        }
        
        .mega-dropdown-menu {
            min-width: 250px;
            width: 250px;
        }
        
        .level-dropdown-menu {
            min-width: 200px;
            width: 200px;
        }
        
        .category-dropdown-menu {
            min-width: 280px;
            width: 280px;
        }
        
        .mega-dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        .level-dropdown-menu {
            left: calc(100% + 2px); /* 减少间距，避免鼠标经过空隙时菜单消失 */
            top: 0;
        }
        
        .level-dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) translateX(0);
        }
        
        .category-dropdown-menu {
            left: calc(100% + 2px); /* 减少间距，避免鼠标经过空隙时菜单消失 */
            top: 0;
        }
        
        .category-dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) translateX(0);
        }
        
        /* Menu positioning and animation improvements */
        .level-dropdown-menu,
        .category-dropdown-menu {
            transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .mega-dropdown-menu.show .mega-dropdown-content,
        .level-dropdown-menu.show .level-dropdown-content,
        .category-dropdown-menu.show .category-dropdown-content {
            animation: slideInFromTop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes slideInFromTop {
            0% {
                opacity: 0;
                transform: translateY(-15px) scale(0.95);
            }
            60% {
                opacity: 0.8;
                transform: translateY(2px) scale(1.01);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Hover effects with enhanced visual feedback */
        .subject-item:hover,
        .level-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            border-left: 3px solid var(--color-primary);
            box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.2);
        }
        
        /* Active states with enhanced styling */
        .subject-item.active,
        .level-item.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.08) 100%);
            border-left: 4px solid var(--color-primary);
            box-shadow: 
                inset 0 0 0 1px rgba(59, 130, 246, 0.3),
                0 2px 8px rgba(59, 130, 246, 0.15);
        }
        
        /* Enhanced category hover effects */
        .category-item:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.12),
                0 4px 10px rgba(0, 0, 0, 0.08);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        /* Menu backdrop for better visual separation */
        .mega-dropdown::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.05);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 999;
            pointer-events: none;
        }
        
        .mega-dropdown.menu-open::before {
            opacity: 1;
            visibility: visible;
        }
        
        .mega-dropdown-content,
        .level-dropdown-content,
        .category-dropdown-content {
            padding: 1.25rem;
        }
        
        /* Subject Items */
        .subjects-grid {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }
        
        .subject-item,
        .level-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.25rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: transparent;
            border: 1px solid transparent;
            margin: 0.125rem;
        }
        
        .subject-item:hover,
        .level-item:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(99, 102, 241, 0.05) 100%);
            transform: translateX(6px) scale(1.02);
            border: 1px solid rgba(59, 130, 246, 0.15);
            box-shadow: 
                0 4px 20px rgba(59, 130, 246, 0.1),
                0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .subject-item.active,
        .level-item.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.12) 0%, rgba(99, 102, 241, 0.08) 100%);
            border: 1px solid rgba(59, 130, 246, 0.25);
            transform: translateX(8px) scale(1.03);
            box-shadow: 
                0 6px 25px rgba(59, 130, 246, 0.15),
                0 3px 10px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }
        
        .subject-icon,
        .level-icon {
            font-size: 1.25rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
            border-radius: 8px;
            color: var(--color-primary);
            margin-right: 1rem;
            transition: all 0.3s ease;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }
        
        .subject-name,
        .level-name {
            font-weight: 600;
            font-size: 0.95rem;
            flex: 1;
            color: #1e293b;
            letter-spacing: -0.01em;
            line-height: 1.4;
        }
        
        .subject-arrow,
        .level-arrow {
            font-size: 0.875rem;
            color: #94a3b8;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
        }
        
        .subject-item:hover .subject-arrow,
        .level-item:hover .level-arrow {
            color: var(--color-primary);
            transform: translateX(6px) scale(1.1);
            opacity: 1;
        }
        
        /* Category Items */
        .categories-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            padding: 1.25rem;
            border-radius: 14px;
            text-decoration: none;
            color: inherit;
            transition: all 0.35s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid rgba(226, 232, 240, 0.8);
            gap: 1rem;
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            position: relative;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .category-item:hover {
            text-decoration: none;
            color: inherit;
            transform: translateY(-4px) scale(1.02);
            box-shadow: 
                0 12px 40px rgba(59, 130, 246, 0.08),
                0 6px 20px rgba(0, 0, 0, 0.06);
            border-color: rgba(59, 130, 246, 0.3);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }
        
        .category-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--color-primary) 0%, rgba(99, 102, 241, 0.8) 100%);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .category-item:hover::before {
            opacity: 1;
        }
        
        .category-icon {
            font-size: 1.5rem;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
            border: 2px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .category-item:hover .category-icon {
            transform: scale(1.1) rotate(3deg);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(99, 102, 241, 0.1) 100%);
        }
        
        /* Subject and Level icons hover effect */
        .subject-item:hover .subject-icon,
        .level-item:hover .level-icon {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(99, 102, 241, 0.1) 100%);
            transform: scale(1.05) rotate(-2deg);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .category-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex: 1;
            min-width: 0;
        }
        
        .category-name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.375rem;
            line-height: 1.3;
            color: #1e293b;
            letter-spacing: -0.02em;
        }
        
        .category-desc {
            color: #64748b;
            font-size: 0.875rem;
            line-height: 1.4;
            font-weight: 500;
            opacity: 0.8;
        }
        
        /* Pulse animation for loading states */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }
        
        .menu-loading {
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* Smooth staggered animation for menu items */
        .subject-item,
        .level-item,
        .category-item {
            animation: slideInStagger 0.4s ease-out backwards;
        }
        
        .subject-item:nth-child(1) { animation-delay: 0.1s; }
        .subject-item:nth-child(2) { animation-delay: 0.15s; }
        .subject-item:nth-child(3) { animation-delay: 0.2s; }
        .subject-item:nth-child(4) { animation-delay: 0.25s; }
        
        .level-item:nth-child(1) { animation-delay: 0.1s; }
        .level-item:nth-child(2) { animation-delay: 0.15s; }
        .level-item:nth-child(3) { animation-delay: 0.2s; }
        .level-item:nth-child(4) { animation-delay: 0.25s; }
        .level-item:nth-child(5) { animation-delay: 0.3s; }
        
        .category-item:nth-child(1) { animation-delay: 0.1s; }
        .category-item:nth-child(2) { animation-delay: 0.15s; }
        .category-item:nth-child(3) { animation-delay: 0.2s; }
        .category-item:nth-child(4) { animation-delay: 0.25s; }
        .category-item:nth-child(5) { animation-delay: 0.3s; }
        
        @keyframes slideInStagger {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Category Colors - Enhanced gradients */
        .books-color {
            background: linear-gradient(135deg, #8b5cf6 0%, #a855f7 50%, #c084fc 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.25);
        }
        
        .homework-color {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 50%, #fca5a5 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.25);
        }
        
        .tests-color {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 50%, #fde047 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.25);
        }
        
        .notes-color {
            background: linear-gradient(135deg, #22c55e 0%, #4ade80 50%, #86efac 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.25);
        }
        
        .questions-color {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 50%, #67e8f9 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(6, 182, 212, 0.25);
        }
        
        /* Enhanced Responsive Design */
        @media (max-width: 991.98px) {
            .mega-dropdown-menu,
            .level-dropdown-menu,
            .category-dropdown-menu {
                position: fixed;
                left: 50% !important;
                top: 50% !important;
                transform: translate(-50%, -50%) scale(0.95);
                width: 92vw;
                max-width: 420px;
                max-height: 85vh;
                overflow-y: auto;
                border-radius: 20px;
                box-shadow: 
                    0 25px 80px rgba(0, 0, 0, 0.15),
                    0 10px 40px rgba(0, 0, 0, 0.08);
            }
            
            .mega-dropdown-menu.show,
            .level-dropdown-menu.show,
            .category-dropdown-menu.show {
                transform: translate(-50%, -50%) scale(1);
            }
            
            .level-dropdown-menu,
            .category-dropdown-menu {
                margin-left: 0;
            }
            
            /* Mobile-optimized menu items */
            .subject-item,
            .level-item {
                padding: 1.25rem 1.5rem;
                margin: 0.25rem;
            }
            
            .category-item {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .category-icon {
                width: 52px;
                height: 52px;
            }
            
            .subject-icon,
            .level-icon {
                width: 36px;
                height: 36px;
            }
        }
        
        /* Small screen optimizations */
        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .btn-primary, .btn-outline-primary {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            
            .display-4 {
                font-size: 2rem !important;
            }
            
            .fs-5 {
                font-size: 1rem !important;
            }
            
            /* Menu specific mobile improvements */
            .mega-dropdown-content,
            .level-dropdown-content,
            .category-dropdown-content {
                padding: 1rem;
            }
            
            .subject-name,
            .level-name {
                font-size: 0.9rem;
            }
            
            .category-name {
                font-size: 0.95rem;
            }
            
            .category-desc {
                font-size: 0.8rem;
            }
        }
        
        /* Extra small devices (phones in portrait mode) */
        @media (max-width: 576px) {
            .mega-dropdown-menu,
            .level-dropdown-menu,
            .category-dropdown-menu {
                width: 96vw;
                max-height: 90vh;
                border-radius: 16px;
            }
            
            .subject-item,
            .level-item {
                padding: 1rem 1.25rem;
            }
            
            .category-item {
                padding: 1.25rem;
            }
            
            .category-icon {
                width: 44px;
                height: 44px;
                font-size: 1.3rem;
            }
            
            .subject-icon,
            .level-icon {
                width: 28px;
                height: 28px;
                font-size: 1.1rem;
            }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="{{ url_for('index') }}">
                <i class="fas fa-graduation-cap me-2" style="color: var(--color-primary); font-size: 1.5rem;"></i>
                <span>STEM Academic</span>
            </a>
            
            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" style="box-shadow: none;">
                <i class="fa-solid fa-bars" style="color: var(--color-primary); font-size: 1.2rem;"></i>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'index' else '' }}" href="{{ url_for('index') }}">
                            <i class="fas fa-home me-1"></i>
                            Home
                        </a>
                    </li>
                    
                    <!-- Resources - Three Level Navigation -->
                    <li class="nav-item dropdown mega-dropdown" id="resourcesMenu">
                        <a class="nav-link dropdown-toggle {{ 'active' if request.endpoint in ['subjects_category', 'view_resource', 'competitions', 'university_resources', 'other_resources'] else '' }}" href="javascript:void(0)" id="resourcesDropdown" role="button">
                            <i class="fas fa-folder-open me-1"></i>
                            Resources
                        </a>
                        
                        <!-- Level 1: Subjects Menu -->
                        <div class="mega-dropdown-menu" id="subjectsMenu">
                            <div class="mega-dropdown-content">
                                <div class="subjects-grid">
                                    <div class="subject-item" data-subject="math">
                                        <i class="fas fa-calculator subject-icon"></i>
                                        <span class="subject-name">Mathematics</span>
                                        <i class="fas fa-chevron-right subject-arrow"></i>
                                    </div>
                                    <div class="subject-item" data-subject="physics">
                                        <i class="fas fa-atom subject-icon"></i>
                                        <span class="subject-name">Physics</span>
                                        <i class="fas fa-chevron-right subject-arrow"></i>
                                    </div>
                                    <div class="subject-item" data-subject="chemistry">
                                        <i class="fas fa-flask subject-icon"></i>
                                        <span class="subject-name">Chemistry</span>
                                        <i class="fas fa-chevron-right subject-arrow"></i>
                                    </div>
                                    <div class="subject-item" data-subject="biology">
                                        <i class="fas fa-dna subject-icon"></i>
                                        <span class="subject-name">Biology</span>
                                        <i class="fas fa-chevron-right subject-arrow"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Level 2: Education Levels Menu (nested inside Subjects menu) -->
                            <div class="level-dropdown-menu" id="levelsMenu">
                            <div class="level-dropdown-content">
                                <div class="levels-grid">
                                    <div class="level-item" data-level="igcse">
                                        <i class="fas fa-graduation-cap level-icon"></i>
                                        <span class="level-name">IGCSE</span>
                                        <i class="fas fa-chevron-right level-arrow"></i>
                                    </div>
                                    <div class="level-item" data-level="alevel">
                                        <i class="fas fa-user-graduate level-icon"></i>
                                        <span class="level-name">A-Level</span>
                                        <i class="fas fa-chevron-right level-arrow"></i>
                                    </div>
                                    <div class="level-item" data-level="ap">
                                        <i class="fas fa-trophy level-icon"></i>
                                        <span class="level-name">AP</span>
                                        <i class="fas fa-chevron-right level-arrow"></i>
                                    </div>
                                    <div class="level-item" data-level="competition">
                                        <i class="fas fa-medal level-icon"></i>
                                        <span class="level-name">Competition</span>
                                        <i class="fas fa-chevron-right level-arrow"></i>
                                    </div>
                                    <div class="level-item" data-level="university">
                                        <i class="fas fa-university level-icon"></i>
                                        <span class="level-name">University</span>
                                        <i class="fas fa-chevron-right level-arrow"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Level 3: Categories Menu (nested inside Levels menu) -->
                            <div class="category-dropdown-menu" id="categoriesMenu">
                            <div class="category-dropdown-content">
                                <div class="categories-grid">
                                    <a href="javascript:void(0)" class="category-item" data-category="books">
                                        <i class="fas fa-book category-icon books-color"></i>
                                        <div class="category-content">
                                            <span class="category-name">Books</span>
                                            <small class="category-desc">Textbooks & References</small>
                                        </div>
                                    </a>
                                    <a href="javascript:void(0)" class="category-item" data-category="homework">
                                        <i class="fas fa-pencil-alt category-icon homework-color"></i>
                                        <div class="category-content">
                                            <span class="category-name">Homework</span>
                                            <small class="category-desc">Homework Papers</small>
                                        </div>
                                    </a>
                                    <a href="javascript:void(0)" class="category-item" data-category="tests">
                                        <i class="fas fa-file-alt category-icon tests-color"></i>
                                        <div class="category-content">
                                            <span class="category-name">Tests</span>
                                            <small class="category-desc">Test & Past Papers</small>
                                        </div>
                                    </a>
                                    <a href="javascript:void(0)" class="category-item" data-category="notes">
                                        <i class="fas fa-sticky-note category-icon notes-color"></i>
                                        <div class="category-content">
                                            <span class="category-name">Notes</span>
                                            <small class="category-desc">Study Notes</small>
                                        </div>
                                    </a>
                                    <a href="javascript:void(0)" class="category-item" data-category="questions">
                                        <i class="fas fa-question-circle category-icon questions-color"></i>
                                        <div class="category-content">
                                            <span class="category-name">Questions</span>
                                            <small class="category-desc">Q&A Community</small>
                                        </div>
                                    </a>
                                </div>
                            </div>
                            </div> <!-- End of categories menu -->
                            </div> <!-- End of levels menu -->
                        </div> <!-- End of subjects menu -->
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint in ['forum', 'forum_post_detail', 'forum_new_post'] else '' }}" href="/forum">
                            <i class="fas fa-question-circle me-1"></i>
                            Questions
                        </a>
                    </li>
                    
                    
                    <li class="nav-item">
                        <a class="nav-link {{ 'active' if request.endpoint == 'submit_resource_page' else '' }}" href="{{ url_for('submit_resource_page') }}">
                            <i class="fas fa-upload me-1"></i>
                            Submit Resource
                        </a>
                    </li>
                    
                    {% if current_user.is_authenticated %}
                        <!-- 已登录用户的菜单 -->
                        <li class="nav-item">
                            <a class="nav-link {{ 'active' if request.endpoint == 'my_resources' else '' }}" href="{{ url_for('my_resources') }}">
                                <i class="fas fa-user-circle me-1"></i>
                                My Resources
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ 'active' if request.endpoint == 'profile' else '' }}" href="{{ url_for('profile') }}">
                                <i class="fas fa-user-cog me-1"></i>
                                Profile
                            </a>
                        </li>
                        {% if current_user.user_role == 'admin' or current_user.user_role == 'moderator' %}
                        <li class="nav-item">
                            <a class="nav-link {{ 'active' if request.endpoint and request.endpoint.startswith('admin_') else '' }}" href="{{ url_for('admin_dashboard') }}">
                                <i class="fas fa-shield-alt me-1"></i>
                                Admin
                            </a>
                        </li>
                        {% endif %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt me-1"></i>
                                Logout
                            </a>
                        </li>
                    {% else %}
                        <!-- 匿名用户的菜单 -->
                        <li class="nav-item">
                            <a class="nav-link {{ 'active' if request.endpoint == 'login' else '' }}" href="{{ url_for('login') }}">
                                <i class="fas fa-sign-in-alt me-1"></i>
                                Login
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link {{ 'active' if request.endpoint == 'register' else '' }}" href="{{ url_for('register') }}">
                                <i class="fas fa-user-plus me-1"></i>
                                Register
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-5 pt-4">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show" role="alert">
                        <div class="d-flex align-items-center">
                            {% if category == 'success' %}
                                <i class="fas fa-check-circle me-3"></i>
                            {% elif category == 'error' %}
                                <i class="fas fa-exclamation-triangle me-3"></i>
                            
                                <i class="fas fa-info-circle me-3"></i>
                            {% endif %}
                            <span>{{ message }}</span>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="py-5 mt-5" style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: #e2e8f0;">
        <div class="container">
            <div class="row g-4 mb-4">
                <div class="col-lg-3 col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-graduation-cap me-2" style="color: #60a5fa; font-size: 1.5rem;"></i>
                        <span class="fw-bold fs-5" style="color: #fff; font-family: var(--font-sans);">STEM Academic</span>
                    </div>
                    <p class="mb-3" style="color: #cbd5e1;">
                        Empowering IGCSE & A-Level students with quality academic resources, collaborative forums, and peer support in STEM subjects.
                    </p>
                    <div class="d-flex gap-3">
                        <a href="#" class="text-decoration-none" style="color: #60a5fa; transition: color 0.3s ease;">
                            <i class="fa-brands fa-github fs-5"></i>
                        </a>
                        <a href="#" class="text-decoration-none" style="color: #60a5fa; transition: color 0.3s ease;">
                            <i class="fa-brands fa-discord fs-5"></i>
                        </a>
                        <a href="#" class="text-decoration-none" style="color: #60a5fa; transition: color 0.3s ease;">
                            <i class="fa-brands fa-reddit fs-5"></i>
                        </a>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <h5 class="text-white mb-3">Quick Links</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="{{ url_for('index') }}" class="text-decoration-none" style="color: #cbd5e1; transition: color 0.3s ease;">Home</a></li>
                        <li class="mb-2"><a href="{{ url_for('subjects_overview') }}" class="text-decoration-none" style="color: #cbd5e1; transition: color 0.3s ease;">Resource Library</a></li>
                        <li class="mb-2"><a href="/forum" class="text-decoration-none" style="color: #cbd5e1; transition: color 0.3s ease;">Community Forum</a></li>
                        {% if current_user.is_authenticated %}
                        <li class="mb-2"><a href="{{ url_for('my_resources') }}" class="text-decoration-none" style="color: #cbd5e1; transition: color 0.3s ease;">My Resources</a></li>
                        {% else %}
                        <li class="mb-2"><a href="{{ url_for('login') }}" class="text-decoration-none" style="color: #cbd5e1; transition: color 0.3s ease;">Login</a></li>
                        {% endif %}
                    </ul>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <h5 class="text-white mb-3">Resource Categories</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="/category/books" class="text-decoration-none" style="color: #cbd5e1; transition: color 0.3s ease;">Books & Materials</a></li>
                        <li class="mb-2"><a href="/category/homework" class="text-decoration-none" style="color: #cbd5e1; transition: color 0.3s ease;">Homework Help</a></li>
                        <li class="mb-2"><a href="/category/experience" class="text-decoration-none" style="color: #cbd5e1; transition: color 0.3s ease;">Study Experiences</a></li>
                        <li class="mb-2"><a href="/category/questions" class="text-decoration-none" style="color: #cbd5e1; transition: color 0.3s ease;">Q&A Discussions</a></li>
                    </ul>
                </div>
                
                <div class="col-lg-3 col-md-6">
                    <h5 class="text-white mb-3">Community</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="/about" class="text-decoration-none" style="color: #cbd5e1; transition: color 0.3s ease;">About Platform</a></li>
                        <li class="mb-2"><a href="/help" class="text-decoration-none" style="color: #cbd5e1; transition: color 0.3s ease;">Help & Guidelines</a></li>
                        <li class="mb-2"><a href="/privacy" class="text-decoration-none" style="color: #cbd5e1; transition: color 0.3s ease;">Privacy Policy</a></li>
                        <li class="mb-2"><a href="/contact" class="text-decoration-none" style="color: #cbd5e1; transition: color 0.3s ease;">Contact Support</a></li>
                    </ul>
                </div>
            </div>
            
            <hr style="border-color: #3b82f6; opacity: 0.3;">
            <div class="text-center pt-3">
                <p class="mb-0" style="color: #94a3b8;">
                    <i class="fas fa-graduation-cap me-2"></i>
                    © 2025 STEM Academic Resources Platform - Empowering IGCSE & A-Level Education | 
                    <i class="fas fa-users mx-2" style="color: #60a5fa;"></i>
                    Building Future Scientists
                </p>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS - Local -->
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    
    
    <!-- Custom JS -->
    <script>
        // Auto-hide flash messages after 5 seconds
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            });
        }, 5000);
        
        // Multi-level dropdown functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Handle desktop hover for submenus
            const dropdownSubmenus = document.querySelectorAll('.dropdown-submenu');
            
            dropdownSubmenus.forEach(function(submenu) {
                const submenuToggle = submenu.querySelector('.dropdown-toggle');
                const submenuDropdown = submenu.querySelector('.dropdown-menu');
                
                // Desktop hover behavior
                submenu.addEventListener('mouseenter', function() {
                    if (window.innerWidth > 767) {
                        submenuDropdown.style.display = 'block';
                    }
                });
                
                submenu.addEventListener('mouseleave', function() {
                    if (window.innerWidth > 767) {
                        submenuDropdown.style.display = 'none';
                    }
                });
                
                // Mobile click behavior
                submenuToggle.addEventListener('click', function(e) {
                    if (window.innerWidth <= 767) {
                        e.preventDefault();
                        const isVisible = submenuDropdown.style.display === 'block';
                        submenuDropdown.style.display = isVisible ? 'none' : 'block';
                    }
                });
            });
            
            // Close all submenus when main dropdown closes
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown')) {
                    dropdownSubmenus.forEach(function(submenu) {
                        const submenuDropdown = submenu.querySelector('.dropdown-menu');
                        submenuDropdown.style.display = 'none';
                    });
                }
            });
        });
        
        // Add hover effects to footer links
        document.addEventListener('DOMContentLoaded', function() {
            const footerLinks = document.querySelectorAll('footer a');
            footerLinks.forEach(link => {
                link.addEventListener('mouseenter', function() {
                    this.style.color = '#fff';
                });
                link.addEventListener('mouseleave', function() {
                    if (this.style.color !== '#fbbf24') {
                        this.style.color = '#fde68a';
                    }
                });
            });
        });
    </script>
    
    {% block extra_js %}{% endblock %}
    
    <script>
        // Language switching function
        
        // 语言切换功能
        function changeLanguage(languageCode) {
            // 显示加载状态
            const loadingHtml = `
                <div class="d-flex justify-content-center align-items-center py-3">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>Switching language...</span>
                </div>
            `;
            
            // 可以在这里显示加载状态
            
            // 调用后端 API 切换语言
            fetch(`/set_language/${languageCode}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 刷新页面以应用新语言
                    window.location.reload();
                } else {
                    console.error('语言切换失败:', data.error);
                    alert('语言切换失败，请稍后再试');
                }
            })
            .catch(error => {
                console.error('请求错误:', error);
                alert('网络错误，请稍后再试');
            });
        }
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 可以在这里添加其他初始化代码
        });

        // Initialize menus when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check for essential elements  
            const resourcesBtn = document.getElementById('resourcesDropdown');
            const subjectsMenu = document.getElementById('subjectsMenu');
            const levelsMenu = document.getElementById('levelsMenu');
            const categoriesMenu = document.getElementById('categoriesMenu');
            
            if (!resourcesBtn || !subjectsMenu || !levelsMenu || !categoriesMenu) {
                return;
            }
            
            // Core menu functions
            function showMenu(menuName, delay = 100) {
                const menu = document.getElementById(menuName);
                if (menu) {
                    setTimeout(() => {
                        menu.classList.add('show');
                    }, delay);
                }
            }
            
            function hideMenu(menuName, delay = 0) {
                const menu = document.getElementById(menuName);
                if (!menu) return;
                
                const wasVisible = menu.classList.contains('show');
                
                if (delay === 0) {
                    menu.classList.remove('show');
                } else {
                    setTimeout(() => {
                        menu.classList.remove('show');
                    }, delay);
                }
            }
            
            function hideAllMenus(delay = 0, includeMainMenu = false) {
                if (includeMainMenu) {
                    hideMenu('subjectsMenu', delay);
                }
                hideMenu('levelsMenu', delay);
                hideMenu('categoriesMenu', delay);
            }
            
            // Timer management
            let activeTimers = {
                hide: null,
                show: null
            };
            
            function clearAllTimers() {
                Object.values(activeTimers).forEach(timer => {
                    if (timer) clearTimeout(timer);
                });
                activeTimers = { hide: null, show: null };
            }
            
            // Position menus dynamically
            function positionLevelsMenu() {
                const levelsMenu = document.getElementById('levelsMenu');
                const resourcesBtn = document.getElementById('resourcesDropdown');
                
                if (levelsMenu && resourcesBtn) {
                    const btnRect = resourcesBtn.getBoundingClientRect();
                    const menuHeight = 300;
                    const viewportHeight = window.innerHeight;
                    const spaceBelow = viewportHeight - btnRect.bottom;
                    
                    let maxTop = Math.max(20, Math.min(btnRect.bottom, spaceBelow - menuHeight));
                    levelsMenu.style.top = maxTop + 'px';
                }
            }
            
            function positionCategoriesMenu() {
                const categoriesMenu = document.getElementById('categoriesMenu');
                const resourcesBtn = document.getElementById('resourcesDropdown');
                
                if (categoriesMenu && resourcesBtn) {
                    const btnRect = resourcesBtn.getBoundingClientRect();
                    const menuHeight = 300;
                    const viewportHeight = window.innerHeight;
                    const spaceBelow = viewportHeight - btnRect.bottom;
                    
                    let maxTop = Math.max(20, Math.min(btnRect.bottom, spaceBelow - menuHeight));
                    categoriesMenu.style.top = maxTop + 'px';
                }
            }
            
            // Mouse tracking
            function isMouseInElement(element, mouseX, mouseY) {
                if (!element) {
                    return false;
                }
                
                if (!element.classList.contains('show')) {
                    return false;
                }
                
                const rect = element.getBoundingClientRect();
                const margin = 10;
                
                return mouseX >= rect.left - margin && 
                       mouseX <= rect.right + margin && 
                       mouseY >= rect.top - margin && 
                       mouseY <= rect.bottom + margin;
            }
            
            function isMouseInResourcesDropdown(mouseX, mouseY) {
                const resourcesBtn = document.getElementById('resourcesDropdown');
                const subjectsMenu = document.getElementById('subjectsMenu');
                const levelsMenu = document.getElementById('levelsMenu');
                const categoriesMenu = document.getElementById('categoriesMenu');
                
                if (!resourcesBtn) return false;
                
                const btnRect = resourcesBtn.getBoundingClientRect();
                const margin = 10;
                
                return (
                    (mouseX >= btnRect.left - margin && mouseX <= btnRect.right + margin && 
                     mouseY >= btnRect.top - margin && mouseY <= btnRect.bottom + margin) ||
                    isMouseInElement(subjectsMenu, mouseX, mouseY) ||
                    isMouseInElement(levelsMenu, mouseX, mouseY) ||
                    isMouseInElement(categoriesMenu, mouseX, mouseY)
                );
            }
            
            // Event listeners
            document.addEventListener('mousemove', function(e) {
                clearAllTimers();
                
                if (isMouseInResourcesDropdown(e.clientX, e.clientY)) {
                    // Mouse in menu area
                } else {
                    // Mouse outside - start hide timer
                    activeTimers.hide = setTimeout(() => {
                        hideAllMenus(0, true);
                    }, 200);
                }
            });
            
            document.addEventListener('click', function(e) {
                const resourcesBtn = document.getElementById('resourcesDropdown');
                if (!resourcesBtn) return;
                
                const isOpen = document.getElementById('subjectsMenu')?.classList.contains('show');
                
                if (!isOpen) {
                    return;
                }
                
                const clickX = e.clientX;
                const clickY = e.clientY;
                
                if (isMouseInResourcesDropdown(clickX, clickY)) {
                    // Click inside menu - don't close
                } else {
                    // Click outside - close all menus
                    hideAllMenus(0, true);
                    clearAllTimers();
                }
            });
            
            // Resources button click handler
            resourcesBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const isOpen = document.getElementById('subjectsMenu')?.classList.contains('show');
                
                if (isOpen) {
                    hideAllMenus(0, true);
                    clearAllTimers();
                } else {
                    clearAllTimers();
                    showMenu('subjectsMenu', 100);
                    positionLevelsMenu();
                    showMenu('levelsMenu', 100);
                    hideMenu('categoriesMenu', 0);
                    positionCategoriesMenu();
                    showMenu('categoriesMenu', 100);
                }
            });
            
            // Escape key handler
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideAllMenus(0, true);
                    clearAllTimers();
                }
            });
            
            // State tracking
            let currentSubject = null;
            let currentLevel = null;
            
            // Navigation handlers
            function navigateToCategory(subject, level, category) {
                const url = `/subjects/${subject}/${level}/${category}`;
                window.location.href = url;
            }
            
            // Update category links with current subject and level
            function updateCategoryLinks(subject, level) {
                if (!subject || !level) return;
                
                const categoryItems = document.querySelectorAll('.category-item');
                categoryItems.forEach(item => {
                    const category = item.dataset.category;
                    if (category) {
                        const url = `/subjects/${subject}/${level}/${category}`;
                        item.href = url;
                        item.dataset.subject = subject;
                        item.dataset.level = level;
                    }
                });
            }
            
            // Subject items hover - show education levels
            const subjectItems = document.querySelectorAll('.subject-item');
            subjectItems.forEach(item => {
                item.addEventListener('mouseenter', (e) => {
                    // Remove active state from other subjects
                    subjectItems.forEach(s => s.classList.remove('active'));
                    item.classList.add('active');
                    
                    currentSubject = item.dataset.subject;
                    
                    // Position the levels menu relative to the hovered item
                    const rect = item.getBoundingClientRect();
                    const menuRect = subjectsMenu.getBoundingClientRect();
                    const relativeTop = Math.max(0, rect.top - menuRect.top);
                    
                    // Ensure menu doesn't go off screen
                    const viewportHeight = window.innerHeight;
                    const menuHeight = 280;
                    const maxTop = Math.min(relativeTop, viewportHeight - menuHeight - 100);
                    
                    levelsMenu.style.top = maxTop + 'px';
                    levelsMenu.style.left = '';
                    showMenu('levelsMenu', 100);
                    hideMenu('categoriesMenu', 0);
                });
                
                // Add click handler for subject items
                item.addEventListener('click', (e) => {
                    const subject = item.dataset.subject;
                    if (subject) {
                        e.preventDefault();
                        hideAllMenus(0, true);
                        window.location.href = `/subjects/${subject}`;
                    }
                });
            });
            
            // Education level items hover - show categories
            const levelItems = document.querySelectorAll('.level-item');
            levelItems.forEach(item => {
                item.addEventListener('mouseenter', (e) => {
                    // Remove active state from other levels
                    levelItems.forEach(l => l.classList.remove('active'));
                    item.classList.add('active');
                    
                    currentLevel = item.dataset.level;
                    
                    // Position the categories menu relative to the hovered item
                    const rect = item.getBoundingClientRect();
                    const menuRect = levelsMenu.getBoundingClientRect();
                    const relativeTop = Math.max(0, rect.top - menuRect.top);
                    
                    // Ensure menu doesn't go off screen
                    const viewportHeight = window.innerHeight;
                    const menuHeight = 350;
                    const maxTop = Math.min(relativeTop, viewportHeight - menuHeight - 100);
                    
                    categoriesMenu.style.top = maxTop + 'px';
                    categoriesMenu.style.left = '';
                    showMenu('categoriesMenu', 100);
                    
                    // Update category links with current subject and level
                    updateCategoryLinks(currentSubject, currentLevel);
                });
                
                // Add click handler for level items
                item.addEventListener('click', (e) => {
                    const level = item.dataset.level;
                    if (currentSubject && level) {
                        e.preventDefault();
                        hideAllMenus(0, true);
                        window.location.href = `/subjects/${currentSubject}/${level}`;
                    }
                });
            });
            
            // Category click handlers
            const categoryItems = document.querySelectorAll('.category-item');
            categoryItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    const category = item.dataset.category;
                    
                    // Check if we have current subject and level
                    if (currentSubject && currentLevel && category) {
                        // Generate the URL dynamically on click
                        const url = `/subjects/${currentSubject}/${currentLevel}/${category}`;
                        
                        // Add a subtle click animation
                        item.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            item.style.transform = '';
                        }, 150);
                        
                        hideAllMenus(0, true);
                        
                        // Navigate to the URL
                        e.preventDefault();
                        window.location.href = url;
                    } else {
                        // Prevent navigation if we don't have required data
                        e.preventDefault();
                        alert('Please select subject and level first');
                    }
                });
            });
            
            // Add visual feedback for touch devices
            if ('ontouchstart' in window) {
                subjectItems.forEach(item => {
                    item.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        item.click();
                    });
                });
                
                levelItems.forEach(item => {
                    item.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        item.click();
                    });
                });
            }
        });
    </script>
    
    
    {% block scripts %}{% endblock %}
</body>
</html>